# Bug Report: PowerShell Terminal Integration Failure

## Summary
PowerShell terminal commands fail with parser errors since Cursor update from October 5, 2025.

## Environment
- **OS**: Windows 10 (Build 26100)
- **Cursor Version**: Updated on October 5, 2025
- **Shell**: Windows PowerShell 5.1 (`C:\WINDOWS\System32\WindowsPowerShell\v1.0\powershell.exe`)
- **Previously tested with**: PowerShell 7 (same issue)
- **Workspace**: `D:\Cursor.ai\The Chef's Numbers`

## Problem Description

### Symptoms
Almost all terminal commands executed through Cursor's `run_terminal_cmd` tool fail with identical parser errors:

```
ParserError: C:\Users\stefa\AppData\Local\Temp\ps-script-[guid].ps1:109
Line |
 109 |  ... coding]::UTF8.GetString([System.Convert]::FromBase64String(''{1}''))) ...
     |                                                                 ~
     | Missing ')' in method call.
```

### Root Cause Identified

The temporary PowerShell script generated by Cursor contains a critical bug in **line 109**:

```powershell
Emit ('Set-Item -LiteralPath ''Env:{0}'' -Value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(''{1}'')))' -f $var.Name, $encoded)
```

**The Issue**: When the Base64-encoded environment variable value (`$encoded`) contains curly braces `{}` after encoding, PowerShell's format operator `-f` interprets these as format placeholders, causing a syntax error.

### When It Started
- **Exact Date**: October 5, 2025
- **Correlation**: Cursor update on this date
- **Before**: Terminal integration worked perfectly
- **After**: All commands fail with parser error in line 109

## Reproduction Steps

1. Open Cursor with any workspace
2. Use Windows PowerShell 5.1 or PowerShell 7
3. Navigate to a directory with a path containing special characters or where environment variables would contain curly braces when Base64-encoded
4. Execute any terminal command through Cursor's AI terminal integration
5. Command fails with parser error in line 109 of temporary script

### Commands That Fail
- `dir`
- `Get-Location`
- `pwd`
- `echo %CD%`
- Any command with parameters containing special characters

### Commands That Sometimes Work
- Simple commands without environment variable serialization needs: `echo "text"`, `cd "path"`

## Technical Analysis

### The Problematic Code
Found in: `C:\Users\stefa\AppData\Local\Temp\ps-script-[guid].ps1`

```powershell
function Dump-PowerShellState {
    # ... 
    $envVars = Get-ChildItem Env: | Sort-Object Name
    foreach ($var in $envVars) {
        $encoded = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes([string]$var.Value))
        # BUG IS HERE - Line 109:
        Emit ('Set-Item -LiteralPath ''Env:{0}'' -Value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(''{1}'')))' -f $var.Name, $encoded)
    }
    # ...
}
```

### Why It Fails
1. Environment variable values are Base64-encoded
2. Some encoded values contain `{` or `}` characters
3. PowerShell's `-f` format operator treats `{0}` and `{1}` as placeholders
4. When `$encoded` contains `{` or `}`, PowerShell parser gets confused
5. Results in "Missing ')' in method call" error

### Example Scenario
If an environment variable value after Base64 encoding results in something like:
```
U29tZVZhbHVle3Rlc3R9
```

The format string becomes malformed because of the embedded `{}` in the Base64 string.

## Attempted Solutions

### What Did NOT Work
1. ✗ Reinstalling Cursor completely
2. ✗ Clearing all Cursor settings and cache
3. ✗ Switching from PowerShell 7 to Windows PowerShell 5.1
4. ✗ Switching from Windows PowerShell 5.1 to PowerShell 7
5. ✗ Adding antivirus exceptions
6. ✗ Checking/modifying PowerShell execution policies

### What Partially Worked
- Removing PowerShell 7 and adding antivirus exceptions allowed some simple commands to work
- However, once the working directory changed to the project path, the issue returned

## Suggested Fix

Replace line 109 in the temporary script template with a version that doesn't use format placeholders within the Base64 string:

```powershell
# Current (BROKEN):
Emit ('Set-Item -LiteralPath ''Env:{0}'' -Value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(''{1}'')))' -f $var.Name, $encoded)

# Suggested fix:
$envCommand = "Set-Item -LiteralPath 'Env:$($var.Name)' -Value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('$encoded')))"
Emit $envCommand
```

Or use proper escaping for the format operator:

```powershell
Emit ('Set-Item -LiteralPath ''Env:{0}'' -Value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(''{1}'')))' -f $var.Name, ($encoded -replace '{','{{' -replace '}','}}'))
```

## Impact

### Severity: CRITICAL
- **All terminal operations through Cursor AI are broken**
- Users cannot execute npm, docker, git, or any other terminal commands via AI
- Severely limits Cursor's usefulness for development workflows
- Affects all Windows users with PowerShell after October 5, 2025 update

### Workaround
Currently, users must:
1. Manually execute all terminal commands outside of Cursor
2. Limit AI to file operations only (read, write, search)
3. Or revert to a Cursor version before October 5, 2025

## Additional Notes

- Issue is **consistent and reproducible** on fresh Cursor installation
- Issue is **independent of PowerShell version** (tested with both 5.1 and 7)
- Issue **did not exist before October 5, 2025**
- No similar reports found online, suggesting recent introduction

## Files for Reference

Recovered temporary script: See above code samples
Error occurs consistently in: `C:\Users\stefa\AppData\Local\Temp\ps-script-*.ps1` (Line 109)

## Request for Cursor Team

1. Please review the PowerShell script template generation code
2. Implement proper escaping for Base64-encoded values used with format operators
3. Consider adding unit tests for environment variable serialization with special characters
4. Provide hotfix or rollback instructions for affected users

---

**Reporter**: User via Cursor AI Assistant
**Date**: October 11, 2025
**Priority**: CRITICAL - Blocks all terminal functionality on Windows



